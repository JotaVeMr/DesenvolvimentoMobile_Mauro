import 'dart:convert';
import 'package:flutter/material.dart';
import 'package:http/http.dart' as http;

void main() {
  runApp(MaterialApp(
    home: WeatherPage(),
    debugShowCheckedModeBanner: false,
  ));
}

class WeatherPage extends StatefulWidget {
  @override
  State<WeatherPage> createState() => _WeatherPageState();
}

class _WeatherPageState extends State<WeatherPage> {
  final TextEditingController _controller = TextEditingController();

  String? temperatura;
  String? umidade;
  String? vento;
  bool loading = false;
  String? erro;

  Future<void> buscarClima(String cidade) async {
    setState(() {
      loading = true;
      erro = null;
      temperatura = null;
      vento = null;
      umidade = null;
    });

    try {
      
      final geoUrl =
          "https://geocoding-api.open-meteo.com/v1/search?name=$cidade&count=1";

      final geoResponse = await http.get(
        Uri.parse(geoUrl),
        headers: {
          "User-Agent": "FlutterApp/1.0 (your_email@example.com)"
        },
);
      final geoData = jsonDecode(geoResponse.body);

      if (geoData.isEmpty) {
        setState(() {
          erro = "Cidade não encontrada!";
          loading = false;
        });
        return;
      }

      final lat = geoData["results"][0]["latitude"];
      final lon = geoData["results"][0]["longitude"];

      
      final weatherUrl =
          "https://api.open-meteo.com/v1/forecast?latitude=$lat&longitude=$lon&current=temperature_2m,relative_humidity_2m,wind_speed_10m";

      final weatherResponse = await http.get(Uri.parse(weatherUrl));
      final weatherData = jsonDecode(weatherResponse.body);

      final current = weatherData["current"];

      setState(() {
        temperatura = "${current["temperature_2m"]} °C";
        umidade = "${current["relative_humidity_2m"]}%";
        vento = "${current["wind_speed_10m"]} km/h";
        loading = false;
      });
    } catch (e) {
      setState(() {
        erro = "Erro ao buscar dados: $e";
        loading = false;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text("Consulta de Clima"),
      ),
      body: Padding(
        padding: const EdgeInsets.all(18),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.stretch,
          children: [
            TextField(
              controller: _controller,
              decoration: InputDecoration(
                labelText: "Digite o nome da cidade",
                border: OutlineInputBorder(),
              ),
            ),
            const SizedBox(height: 12),
            ElevatedButton(
              onPressed: () => buscarClima(_controller.text),
              child: const Text("Buscar"),
            ),
            const SizedBox(height: 20),

            if (loading)
              const Center(child: CircularProgressIndicator()),

            if (erro != null)
              Text(
                erro!,
                style: const TextStyle(color: Colors.red, fontSize: 16),
              ),

            if (temperatura != null) ...[
              Text("Temperatura: $temperatura",
                  style: const TextStyle(fontSize: 18)),
              Text("Umidade: $umidade",
                  style: const TextStyle(fontSize: 18)),
              Text("Velocidade do vento: $vento",
                  style: const TextStyle(fontSize: 18)),
            ]
          ],
        ),
      ),
    );
  }
}
